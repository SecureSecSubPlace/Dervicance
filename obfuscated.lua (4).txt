return function(encryptedString)
    local shift, map, encryptedData = encryptedString:match("^(%d+)%*(.-)%*(.+)$")
    
    if not shift or not map or not encryptedData then
        error("Invalid encrypted string format")
    end

    shift = tonumber(shift) or 0
    local mapTable = {}

    -- Ensure map is valid before parsing
    for num in (map or ""):gmatch("%d+") do
        table.insert(mapTable, tonumber(num))
    end

    if #mapTable == 0 then
        error("Invalid map data")
    end

    -- Decrypt function
    local function decryptChar(char, index)
        local mappedIndex = mapTable[index] or 0
        local decryptedValue = string.byte(char) - (shift % 256) - mappedIndex
        return string.char((decryptedValue % 256) + 1)
    end

    -- Decrypt the data
    local decryptedString = {}
    local index = 1
    for char in encryptedData:gmatch(".") do
        table.insert(decryptedString, decryptChar(char, index))
        index = index + 1
    end

    return table.concat(decryptedString)
end
