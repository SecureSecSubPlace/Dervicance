return function(encText)
    local function decryptString(encText)
        local shift, map, encryptedData = encText:match("([^!]+)!([^!]+)!(.+)")

        if not shift or not map or not encryptedData then
            error("Decryption failed: Invalid encrypted string format.\nString: " .. tostring(encText))
        end

        local shiftValue = tonumber(shift)
        if not shiftValue then
            error("Decryption failed: Invalid shift value.\nString: " .. tostring(encText))
        end

        -- Convert the map back into a number sequence
        local mapTable = {}
        for num in map:gmatch("[^,]+") do
            table.insert(mapTable, tonumber(num) or 0)
        end

        local decryptedString = {}
        local index = 1

        for char in encryptedData:gmatch(".") do
            local mappedIndex = mapTable[index] or 0
            local charByte = string.byte(char)

            if not charByte then
                error("Invalid character in encrypted data: " .. tostring(char))
            end

            local decryptedValue = (charByte - shiftValue - mappedIndex) % 256
            table.insert(decryptedString, string.char(decryptedValue))

            index = index + 1
        end

        local finalDecrypted = table.concat(decryptedString)
        if finalDecrypted == "" then
            error("Decryption failed: Empty output.\nString: " .. tostring(encText))
        end

        print("Decrypted Output: ", finalDecrypted) -- DEBUGGING STEP

        return finalDecrypted
    end

    local decryptedCode = decryptString(encText)
    if not decryptedCode or decryptedCode == "" then
        error("Decryption failed: Output is nil or empty.\nString: " .. tostring(encText))
    end

    local func, err = loadstring(decryptedCode)
    if not func then
        error("Decryption failed: Loadstring error.\nDecrypted Output: " .. decryptedCode .. "\nError: " .. tostring(err))
    end

    return func() -- Run the decrypted code
end
