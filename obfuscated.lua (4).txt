return function(encryptedStr)
    local shift, map, encryptedBytes = encryptedStr:match("^(%d+)|([^|]+)|(.+)$")
    if not shift or not map or not encryptedBytes then
        error("Invalid encrypted format")
    end

    shift = tonumber(shift)
    local mapValues = {}
    for value in map:gmatch("%d+") do
        table.insert(mapValues, tonumber(value))
    end

    local decrypted = {}
    local byteIndex = 1
    for byte in encryptedBytes:gmatch("(%d+)!?") do
        local charShift = mapValues[byteIndex] or 0
        local originalByte = (tonumber(byte) - shift - charShift) % 256
        table.insert(decrypted, string.char(originalByte))
        byteIndex = byteIndex + 1
    end

    local decodedScript = table.concat(decrypted)
    return decodedScript
end
